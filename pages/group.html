<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Landjes Trainer - Deel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4/dist/maplibre-gl.css">
  <script src="https://unpkg.com/maplibre-gl@4/dist/maplibre-gl.js"></script>
  <script>
    (function() {
      var id = new URLSearchParams(window.location.search).get('id');
      if (!id) return;
      try {
        var raw = localStorage.getItem('landjes_oefenen_collapsed');
        var state = raw ? JSON.parse(raw) : {};
        if (state[id]) document.documentElement.classList.add('oefenen-collapsed-init');
      } catch (_) {}
    })();
  </script>
</head>
<body>
  <main class="container" style="padding-top: 0.5rem;">
    <!-- Navigation and Title Cards -->
    <div class="header-cards-row">
      <div class="header-card back-card">
        <a href="../index.html" class="back-link-card">&larr; Terug naar home</a>
      </div>
      <div class="header-card title-card">
        <h1 id="group-title" class="group-title-card">Deel</h1>
        <p id="group-meta" class="group-meta-card"></p>
      </div>
    </div>

    <!-- 1. Oefenen: kaart + landenlijst (collapsible) -->
    <section class="group-oefenen-section" aria-label="Oefenen met kaart en landen">
      <h2 class="group-oefenen-header">
        <button type="button" class="group-oefenen-toggle" id="oefenen-toggle" aria-expanded="true" aria-controls="group-oefenen-content">
          <span class="group-oefenen-arrow" aria-hidden="true">▼</span>
          Oefenen
        </button>
      </h2>
      <div id="group-oefenen-content" class="group-oefenen-content">
        <div class="group-map-row" aria-label="Wereldkaart en landen in dit deel">
          <div class="country-preview-box country-preview-map-box filled" style="position: relative;">
            <div id="country-preview-map" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%;"></div>
            <div id="country-preview-flag" class="country-preview-flag-overlay" style="display: none;">
              <img id="country-preview-flag-img" src="" alt="Vlag">
            </div>
          </div>
          <aside class="group-countries-aside">
            <h3 class="group-countries-title">Landen in dit deel</h3>
            <div class="list-search-wrap">
              <label for="countries-list-search" class="visually-hidden">Zoek in landen en hoofdsteden</label>
              <input type="text" class="list-search-input" id="countries-list-search" placeholder="Zoek land of hoofdstad…" autocomplete="off">
            </div>
            <ul id="countries-list" class="plain-list countries-hover-list"></ul>
          </aside>
        </div>
      </div>
    </section>

    <!-- 2. Quiz-modi -->
    <section class="group-quiz-section">
      <div class="group-quiz-header-row">
        <h2>Quiz-modi</h2>
        <label class="group-infinite-toggle">
          <input type="checkbox" id="alles-oneindig" autocomplete="off">
          <span>Alles oneindig</span>
        </label>
      </div>
      <div class="card-grid">
        <article class="card">
          <h3>Hoofdstad / Land</h3>
          <p>Flashcards in beide richtingen.</p>
          <div class="btn-row">
            <a id="capitals-land-to-capital" class="btn primary">Land → Hoofdstad</a>
            <a id="capitals-capital-to-land" class="btn">Hoofdstad → Land</a>
            <a id="capitals-both" class="btn">Beide kanten</a>
          </div>
        </article>

        <article class="card">
          <h3>Vlaggen</h3>
          <p>Herken vlaggen en landen.</p>
          <div class="btn-row">
            <a id="flags-flag-to-land" class="btn primary">Vlag → Land</a>
            <a id="flags-land-to-flag" class="btn">Land → Vlag</a>
            <a id="flags-both" class="btn">Beide kanten</a>
          </div>
        </article>

        <article class="card">
          <h3>Kaart-quiz</h3>
          <p>Herken landen op de kaart.</p>
          <div class="btn-row">
            <a id="map-quiz-snelle" class="btn primary">Snelle quiz</a>
            <a id="map-quiz" class="btn">Kaart-quiz (klik/typ)</a>
            <a id="map-quiz-zoek" class="btn">Zoek op kaart</a>
          </div>
        </article>

        <article class="card">
          <h3>Kwartet</h3>
          <p>Match kaart, landnaam, hoofdstad en vlag per land.</p>
          <div class="btn-row">
            <a id="kwartet-quiz" class="btn primary">Start kwartet-quiz</a>
          </div>
        </article>

        <article class="card">
          <h3>Mix</h3>
          <p>Hoofdstad, vlag en kaart door elkaar.</p>
          <div class="btn-row">
            <a id="mix-quiz" class="btn primary">Start mix-sessie</a>
            <a id="mix-quiz-infinite" class="btn">Mix oneindig</a>
            <a id="mix-quiz-mega" class="btn">Mega mix</a>
          </div>
        </article>

        <article class="card" id="custom-mix-card">
          <h3>Aangepaste mix</h3>
          <p>Kies welke vraagtypen je wilt oefenen. Open de modal en vink aan.</p>
          <div class="btn-row">
            <button type="button" id="custom-mix-open-modal" class="btn primary">Custom mix – kies opties</button>
          </div>
        </article>
      </div>
    </section>
  </main>

  <!-- Custom mix modal -->
  <div id="custom-mix-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="custom-mix-modal-title" aria-hidden="true" style="display: none;">
    <div class="modal-content modal-custom-mix">
      <h2 id="custom-mix-modal-title" class="modal-title">Kies vraagtypen</h2>
      <p class="modal-desc">Vink de vraagtypen aan die je wilt oefenen. Je krijgt alleen deze vragen.</p>
      <div class="custom-mix-modal-options" role="group" aria-label="Selecteer vraagtypen">
        <label class="modal-check"><input type="checkbox" data-custom="land-capital"> Land → Hoofdstad</label>
        <label class="modal-check"><input type="checkbox" data-custom="capital-land"> Hoofdstad → Land</label>
        <label class="modal-check"><input type="checkbox" data-custom="land-flag"> Land → Vlag</label>
        <label class="modal-check"><input type="checkbox" data-custom="flag-land"> Vlag → Land</label>
        <label class="modal-check"><input type="checkbox" data-custom="map-land"> Kaart → Land</label>
        <label class="modal-check"><input type="checkbox" data-custom="capital-flag"> Hoofdstad → Vlag</label>
        <label class="modal-check"><input type="checkbox" data-custom="capital-map"> Hoofdstad → Land (kaart)</label>
        <label class="modal-check"><input type="checkbox" data-custom="flag-capital"> Vlag → Hoofdstad</label>
        <label class="modal-check"><input type="checkbox" data-custom="flag-map"> Vlag → Land (kaart)</label>
        <label class="modal-check"><input type="checkbox" data-custom="map-capital"> Kaart → Hoofdstad</label>
        <label class="modal-check"><input type="checkbox" data-custom="map-flag"> Kaart → Vlag</label>
      </div>
      <div class="modal-actions">
        <button type="button" id="custom-mix-modal-cancel" class="btn">Annuleren</button>
        <button type="button" id="custom-mix-modal-start" class="btn primary" disabled>Start</button>
      </div>
    </div>
  </div>

  <script src="../js/app.js"></script>
  <script src="../js/quiz_map_satellite.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(window.location.search);
      const groupId = params.get('id');
      const titleEl = document.getElementById('group-title');
      const metaEl = document.getElementById('group-meta');
      const countriesListEl = document.getElementById('countries-list');

      if (!groupId) {
        titleEl.textContent = 'Geen deel geselecteerd';
        metaEl.textContent = 'Ga terug naar de homepagina en kies een deel.';
        return;
      }

      try {
        const group = await window.App.loadGroupById(groupId);
        const countriesMap = await window.App.loadCountriesMap();
        titleEl.textContent = group.title;
        metaEl.textContent = `${group.title} · ${group.countries.length} landen`;

        const mapBox = document.getElementById('country-preview-map');
        const mapRow = document.querySelector('.group-map-row');

        // Initialiseer satelliet kaart
        let satelliteMapInitialized = false;
        if (window.SatelliteMap) {
          try {
            await window.SatelliteMap.init('country-preview-map', '../assets/maps/high_res_usa.json');
            satelliteMapInitialized = true;
            console.log('Preview satelliet kaart geïnitialiseerd');
            
            // Zoom naar de landen in dit deel (geen animatie)
            if (group.countries && group.countries.length > 0) {
              window.SatelliteMap.fitToRegion(group.countries, {
                padding: { top: 50, bottom: 50, left: 50, right: 50 },
                maxZoom: 5,
                duration: 0
              });
            }
          } catch (err) {
            console.error('Kon satelliet kaart niet initialiseren:', err);
          }
        }

        const flagOverlay = document.getElementById('country-preview-flag');
        const flagImg = document.getElementById('country-preview-flag-img');

        function showCountryOnMap(iso3) {
          if (satelliteMapInitialized && window.SatelliteMap) {
            window.SatelliteMap.highlightCountry(iso3);
          }
          
          // Toon vlag linksboven
          if (flagOverlay && flagImg) {
            const flagFilename = window.App.getFlagFilename(iso3);
            flagImg.src = `../assets/flags/${flagFilename}`;
            flagImg.alt = `Vlag van ${countriesMap[iso3]?.name_nl || iso3}`;
            flagOverlay.style.display = 'block';
          }
        }

        function clearMap() {
          if (satelliteMapInitialized && window.SatelliteMap) {
            window.SatelliteMap.highlightCountry(null);
          }
          
          // Verberg vlag
          if (flagOverlay) {
            flagOverlay.style.display = 'none';
          }
        }

        group.countries.forEach(iso3 => {
          const c = countriesMap[iso3];
          if (!c) return;
          const li = document.createElement('li');
          li.textContent = `${c.name_nl} — ${c.capitals_nl.join(', ')}`;
          li.dataset.iso = iso3;
          li.dataset.search = (c.name_nl + ' ' + (c.capitals_nl || []).join(' ')).toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
          if (mapBox) {
            li.addEventListener('mouseenter', () => showCountryOnMap(iso3));
          }
          countriesListEl.appendChild(li);
        });

        const countriesListSearch = document.getElementById('countries-list-search');
        if (countriesListSearch) {
          countriesListSearch.addEventListener('input', () => {
            const q = (countriesListSearch.value || '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '').trim();
            countriesListEl.querySelectorAll('li').forEach(li => {
              const show = !q || (li.dataset.search || '').includes(q);
              li.style.display = show ? '' : 'none';
            });
          });
        }

        if (mapRow && mapBox) {
          mapRow.addEventListener('mouseleave', () => clearMap());
        }

        const oefenenToggle = document.getElementById('oefenen-toggle');
        const oefenenContent = document.getElementById('group-oefenen-content');
        const OEFENEN_STORAGE_KEY = 'landjes_oefenen_collapsed';

        function getOefenenCollapsedState() {
          try {
            const raw = localStorage.getItem(OEFENEN_STORAGE_KEY);
            if (!raw) return {};
            return JSON.parse(raw);
          } catch (_) {
            return {};
          }
        }

        function setOefenenCollapsedForGroup(groupId, collapsed) {
          const state = getOefenenCollapsedState();
          state[groupId] = collapsed;
          try {
            localStorage.setItem(OEFENEN_STORAGE_KEY, JSON.stringify(state));
          } catch (_) {}
        }

        function applyOefenenState(collapsed) {
          document.documentElement.classList.toggle('oefenen-collapsed-init', false);
          const arrowEl = oefenenToggle && oefenenToggle.querySelector('.group-oefenen-arrow');
          if (collapsed) {
            oefenenContent.classList.add('collapsed');
            if (oefenenToggle) oefenenToggle.setAttribute('aria-expanded', 'false');
            if (arrowEl) arrowEl.textContent = '▶';
          } else {
            oefenenContent.classList.remove('collapsed');
            if (oefenenToggle) oefenenToggle.setAttribute('aria-expanded', 'true');
            if (arrowEl) arrowEl.textContent = '▼';
          }
        }

        const savedCollapsed = getOefenenCollapsedState()[group.id] === true;
        applyOefenenState(savedCollapsed);

        if (oefenenToggle && oefenenContent) {
          oefenenToggle.addEventListener('click', () => {
            const isCollapsed = oefenenContent.classList.toggle('collapsed');
            setOefenenCollapsedForGroup(group.id, isCollapsed);
            applyOefenenState(isCollapsed);
          });
        }

        const base = `id=${encodeURIComponent(group.id)}`;
        const ALLES_ONEINDIG_KEY = 'landjes_alles_oneindig';

        function getAllesOneindig() {
          try {
            return localStorage.getItem(ALLES_ONEINDIG_KEY) === '1';
          } catch (_) {
            return false;
          }
        }

        function setAllesOneindig(v) {
          try {
            localStorage.setItem(ALLES_ONEINDIG_KEY, v ? '1' : '0');
          } catch (_) {}
        }

        function suffix() {
          return getAllesOneindig() ? '&infinite=1' : '';
        }

        function updateQuizLinks() {
          document.getElementById('capitals-land-to-capital').href =
            `quiz_capitals.html?${base}&mode=land-to-capital${suffix()}`;
          document.getElementById('capitals-capital-to-land').href =
            `quiz_capitals.html?${base}&mode=capital-to-land${suffix()}`;
          document.getElementById('capitals-both').href =
            `quiz_capitals.html?${base}&mode=both`;

          document.getElementById('flags-flag-to-land').href =
            `quiz_flags.html?${base}&mode=flag-to-land${suffix()}`;
          document.getElementById('flags-land-to-flag').href =
            `quiz_flags.html?${base}&mode=land-to-flag${suffix()}`;
          document.getElementById('flags-both').href =
            `quiz_flags.html?${base}&mode=both`;

          document.getElementById('map-quiz-snelle').href =
            `quiz_map.html?${base}&mode=snelle`;
          document.getElementById('map-quiz').href =
            `quiz_map.html?${base}${suffix()}`;
          document.getElementById('map-quiz-zoek').href =
            `quiz_map_zoek.html?${base}${suffix()}`;

          document.getElementById('kwartet-quiz').href =
            `quiz_kwartet.html?${base}${suffix()}`;

          document.getElementById('mix-quiz').href =
            `quiz_mix.html?${base}${suffix()}`;
          document.getElementById('mix-quiz-infinite').href =
            `quiz_mix.html?${base}&infinite=1`;
          document.getElementById('mix-quiz-mega').href =
            `quiz_mix.html?${base}&mega=1${suffix()}`;
        }

        const allesOneindigCheck = document.getElementById('alles-oneindig');
        if (allesOneindigCheck) {
          allesOneindigCheck.checked = getAllesOneindig();
          allesOneindigCheck.addEventListener('change', () => {
            setAllesOneindig(allesOneindigCheck.checked);
            updateQuizLinks();
          });
        }

        updateQuizLinks();

        // Custom mix modal
        const customMixModal = document.getElementById('custom-mix-modal');
        const customMixOpenBtn = document.getElementById('custom-mix-open-modal');
        const customMixCancelBtn = document.getElementById('custom-mix-modal-cancel');
        const customMixStartBtn = document.getElementById('custom-mix-modal-start');
        const customMixCheckboxes = customMixModal ? customMixModal.querySelectorAll('.custom-mix-modal-options input[data-custom]') : [];

        if (customMixOpenBtn && customMixModal) customMixOpenBtn.addEventListener('click', (e) => {
          e.preventDefault();
          customMixModal.style.display = 'flex';
          customMixModal.setAttribute('aria-hidden', 'false');
          customMixModal.classList.add('modal-open');
          document.body.classList.add('modal-open');
          const firstCheck = customMixModal.querySelector('input[type="checkbox"]');
          if (firstCheck) firstCheck.focus();
        });

        function closeCustomMixModal() {
          customMixModal.style.display = 'none';
          customMixModal.setAttribute('aria-hidden', 'true');
          customMixModal.classList.remove('modal-open');
          document.body.classList.remove('modal-open');
          customMixOpenBtn.focus();
        }

        if (customMixCancelBtn) customMixCancelBtn.addEventListener('click', closeCustomMixModal);

        if (customMixModal) {
          customMixModal.addEventListener('click', (e) => {
            if (e.target === customMixModal) closeCustomMixModal();
          });
          customMixModal.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeCustomMixModal();
          });
        }

        function updateCustomMixStartBtn() {
          const checked = Array.from(customMixCheckboxes).filter(cb => cb.checked);
          customMixStartBtn.disabled = checked.length === 0;
        }

        customMixCheckboxes.forEach(cb => cb.addEventListener('change', updateCustomMixStartBtn));

        if (customMixStartBtn) customMixStartBtn.addEventListener('click', () => {
          const checked = Array.from(customMixCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.dataset.custom);
          if (checked.length === 0) return;
          closeCustomMixModal();
          window.location.href = `quiz_mix.html?${base}&custom=${encodeURIComponent(checked.join(','))}${suffix()}`;
        });
      } catch (err) {
        console.error(err);
        titleEl.textContent = 'Fout bij laden van deel';
        metaEl.textContent = 'Controleer of je een webserver gebruikt (bijv. python -m http.server).';
      }
    });
  </script>
</body>
</html>

