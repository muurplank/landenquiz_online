<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Landjes Trainer - Deel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4/dist/maplibre-gl.css">
  <script src="https://unpkg.com/maplibre-gl@4/dist/maplibre-gl.js"></script>
  <script>
    (function() {
      var id = new URLSearchParams(window.location.search).get('id');
      if (!id) return;
      try {
        var raw = localStorage.getItem('landjes_oefenen_collapsed');
        var state = raw ? JSON.parse(raw) : {};
        if (state[id]) document.documentElement.classList.add('oefenen-collapsed-init');
      } catch (_) {}
    })();
  </script>
</head>
<body>
  <main class="container" style="padding-top: 1.5rem;">
    <!-- Navigation and Title Cards -->
    <div class="header-cards-row">
      <div class="header-card back-card">
        <a href="../index.html" class="back-link-card">&larr; Terug naar home</a>
      </div>
      <div class="header-card title-card">
        <h1 id="group-title" class="group-title-card">Deel</h1>
        <p id="group-meta" class="group-meta-card"></p>
      </div>
    </div>

    <!-- 1. Oefenen: kaart + landenlijst (collapsible) -->
    <section class="group-oefenen-section" aria-label="Oefenen met kaart en landen">
      <h2 class="group-oefenen-header">
        <button type="button" class="group-oefenen-toggle" id="oefenen-toggle" aria-expanded="true" aria-controls="group-oefenen-content">
          <span class="group-oefenen-arrow" aria-hidden="true">▼</span>
          Oefenen
        </button>
      </h2>
      <div id="group-oefenen-content" class="group-oefenen-content">
        <div class="group-map-row" aria-label="Wereldkaart en landen in dit deel">
          <div class="country-preview-box country-preview-map-box filled" style="position: relative;">
            <div id="country-preview-map" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%;"></div>
            <div id="country-preview-flag" class="country-preview-flag-overlay" style="display: none;">
              <img id="country-preview-flag-img" src="" alt="Vlag">
            </div>
          </div>
          <aside class="group-countries-aside">
            <h3 class="group-countries-title">Landen in dit deel</h3>
            <ul id="countries-list" class="plain-list countries-hover-list"></ul>
          </aside>
        </div>
      </div>
    </section>

    <!-- 2. Quiz-modi -->
    <section class="group-quiz-section">
      <h2>Quiz-modi</h2>
      <div class="card-grid">
        <article class="card">
          <h3>Hoofdstad / Land</h3>
          <p>Flashcards in beide richtingen.</p>
          <div class="btn-row">
            <a id="capitals-land-to-capital" class="btn primary">Land → Hoofdstad</a>
            <a id="capitals-capital-to-land" class="btn">Hoofdstad → Land</a>
            <a id="capitals-both" class="btn">Beide kanten</a>
          </div>
        </article>

        <article class="card">
          <h3>Vlaggen</h3>
          <p>Herken vlaggen en landen.</p>
          <div class="btn-row">
            <a id="flags-flag-to-land" class="btn primary">Vlag → Land</a>
            <a id="flags-land-to-flag" class="btn">Land → Vlag</a>
            <a id="flags-both" class="btn">Beide kanten</a>
          </div>
        </article>

        <article class="card">
          <h3>Kaart-quiz</h3>
          <p>Herken het wit gemarkeerde land.</p>
          <div class="btn-row">
            <a id="map-quiz" class="btn primary">Start kaart-quiz</a>
          </div>
        </article>

        <article class="card">
          <h3>Kwartet</h3>
          <p>Match kaart, landnaam, hoofdstad en vlag per land.</p>
          <div class="btn-row">
            <a id="kwartet-quiz" class="btn primary">Start kwartet-quiz</a>
          </div>
        </article>

        <article class="card">
          <h3>Mix</h3>
          <p>Hoofdstad, vlag en kaart door elkaar.</p>
          <div class="btn-row">
            <a id="mix-quiz" class="btn primary">Start mix-sessie</a>
            <a id="mix-quiz-infinite" class="btn">Mix oneindig</a>
          </div>
        </article>

        <article class="card" id="custom-mix-card">
          <h3>Aangepaste mix</h3>
          <p>Kies 2 van de 3 quiztypen voor een mix van alleen die twee.</p>
          <div class="custom-mix-options" role="group" aria-label="Selecteer twee quiztypen">
            <label class="custom-mix-check"><input type="checkbox" id="custom-type-capital" value="capital"> Hoofdstad</label>
            <label class="custom-mix-check"><input type="checkbox" id="custom-type-flag" value="flag"> Vlaggen</label>
            <label class="custom-mix-check"><input type="checkbox" id="custom-type-map" value="map"> Kaart</label>
          </div>
          <div class="btn-row" style="margin-top: 0.75rem;">
            <a id="custom-mix-quiz" class="btn" href="#">Start aangepaste mix</a>
          </div>
        </article>
      </div>
    </section>
  </main>

  <script src="../js/app.js"></script>
  <script src="../js/quiz_map_satellite.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(window.location.search);
      const groupId = params.get('id');
      const titleEl = document.getElementById('group-title');
      const metaEl = document.getElementById('group-meta');
      const countriesListEl = document.getElementById('countries-list');

      if (!groupId) {
        titleEl.textContent = 'Geen deel geselecteerd';
        metaEl.textContent = 'Ga terug naar de homepagina en kies een deel.';
        return;
      }

      try {
        const group = await window.App.loadGroupById(groupId);
        const countriesMap = await window.App.loadCountriesMap();
        titleEl.textContent = group.title;
        metaEl.textContent = `${group.title} · ${group.countries.length} landen`;

        const mapBox = document.getElementById('country-preview-map');
        const mapRow = document.querySelector('.group-map-row');

        // Initialiseer satelliet kaart
        let satelliteMapInitialized = false;
        if (window.SatelliteMap) {
          try {
            await window.SatelliteMap.init('country-preview-map', '../assets/maps/high_res_usa.json');
            satelliteMapInitialized = true;
            console.log('Preview satelliet kaart geïnitialiseerd');
            
            // Zoom naar de landen in dit deel (geen animatie)
            if (group.countries && group.countries.length > 0) {
              window.SatelliteMap.fitToRegion(group.countries, {
                padding: { top: 50, bottom: 50, left: 50, right: 50 },
                maxZoom: 5,
                duration: 0
              });
            }
          } catch (err) {
            console.error('Kon satelliet kaart niet initialiseren:', err);
          }
        }

        const flagOverlay = document.getElementById('country-preview-flag');
        const flagImg = document.getElementById('country-preview-flag-img');

        function showCountryOnMap(iso3) {
          if (satelliteMapInitialized && window.SatelliteMap) {
            window.SatelliteMap.highlightCountry(iso3);
          }
          
          // Toon vlag linksboven
          if (flagOverlay && flagImg) {
            const flagFilename = window.App.getFlagFilename(iso3);
            flagImg.src = `../assets/flags/${flagFilename}`;
            flagImg.alt = `Vlag van ${countriesMap[iso3]?.name_nl || iso3}`;
            flagOverlay.style.display = 'block';
          }
        }

        function clearMap() {
          if (satelliteMapInitialized && window.SatelliteMap) {
            window.SatelliteMap.highlightCountry(null);
          }
          
          // Verberg vlag
          if (flagOverlay) {
            flagOverlay.style.display = 'none';
          }
        }

        group.countries.forEach(iso3 => {
          const c = countriesMap[iso3];
          if (!c) return;
          const li = document.createElement('li');
          li.textContent = `${c.name_nl} — ${c.capitals_nl.join(', ')}`;
          li.dataset.iso = iso3;
          if (mapBox) {
            li.addEventListener('mouseenter', () => showCountryOnMap(iso3));
          }
          countriesListEl.appendChild(li);
        });

        if (mapRow && mapBox) {
          mapRow.addEventListener('mouseleave', () => clearMap());
        }

        const oefenenToggle = document.getElementById('oefenen-toggle');
        const oefenenContent = document.getElementById('group-oefenen-content');
        const OEFENEN_STORAGE_KEY = 'landjes_oefenen_collapsed';

        function getOefenenCollapsedState() {
          try {
            const raw = localStorage.getItem(OEFENEN_STORAGE_KEY);
            if (!raw) return {};
            return JSON.parse(raw);
          } catch (_) {
            return {};
          }
        }

        function setOefenenCollapsedForGroup(groupId, collapsed) {
          const state = getOefenenCollapsedState();
          state[groupId] = collapsed;
          try {
            localStorage.setItem(OEFENEN_STORAGE_KEY, JSON.stringify(state));
          } catch (_) {}
        }

        function applyOefenenState(collapsed) {
          document.documentElement.classList.toggle('oefenen-collapsed-init', false);
          const arrowEl = oefenenToggle && oefenenToggle.querySelector('.group-oefenen-arrow');
          if (collapsed) {
            oefenenContent.classList.add('collapsed');
            if (oefenenToggle) oefenenToggle.setAttribute('aria-expanded', 'false');
            if (arrowEl) arrowEl.textContent = '▶';
          } else {
            oefenenContent.classList.remove('collapsed');
            if (oefenenToggle) oefenenToggle.setAttribute('aria-expanded', 'true');
            if (arrowEl) arrowEl.textContent = '▼';
          }
        }

        const savedCollapsed = getOefenenCollapsedState()[group.id] === true;
        applyOefenenState(savedCollapsed);

        if (oefenenToggle && oefenenContent) {
          oefenenToggle.addEventListener('click', () => {
            const isCollapsed = oefenenContent.classList.toggle('collapsed');
            setOefenenCollapsedForGroup(group.id, isCollapsed);
            applyOefenenState(isCollapsed);
          });
        }

        const base = `id=${encodeURIComponent(group.id)}`;
        document.getElementById('capitals-land-to-capital').href =
          `quiz_capitals.html?${base}&mode=land-to-capital`;
        document.getElementById('capitals-capital-to-land').href =
          `quiz_capitals.html?${base}&mode=capital-to-land`;
        document.getElementById('capitals-both').href =
          `quiz_capitals.html?${base}&mode=both`;

        document.getElementById('flags-flag-to-land').href =
          `quiz_flags.html?${base}&mode=flag-to-land`;
        document.getElementById('flags-land-to-flag').href =
          `quiz_flags.html?${base}&mode=land-to-flag`;
        document.getElementById('flags-both').href =
          `quiz_flags.html?${base}&mode=both`;

        document.getElementById('map-quiz').href =
          `quiz_map.html?${base}`;

        document.getElementById('kwartet-quiz').href =
          `quiz_kwartet.html?${base}`;

        document.getElementById('mix-quiz').href =
          `quiz_mix.html?${base}`;
        document.getElementById('mix-quiz-infinite').href =
          `quiz_mix.html?${base}&infinite=1`;

        const customTypeCapital = document.getElementById('custom-type-capital');
        const customTypeFlag = document.getElementById('custom-type-flag');
        const customTypeMap = document.getElementById('custom-type-map');
        const customMixLink = document.getElementById('custom-mix-quiz');
        const customCheckboxes = [customTypeCapital, customTypeFlag, customTypeMap];

        function updateCustomMixLink() {
          const checked = customCheckboxes.filter(cb => cb.checked).map(cb => cb.value);
          if (checked.length === 2) {
            const types = checked.sort().join(',');
            customMixLink.href = `quiz_mix.html?${base}&types=${encodeURIComponent(types)}`;
            customMixLink.classList.add('primary');
            customMixLink.removeAttribute('aria-disabled');
          } else {
            customMixLink.href = '#';
            customMixLink.classList.remove('primary');
            customMixLink.setAttribute('aria-disabled', 'true');
          }
        }

        customMixLink.addEventListener('click', (e) => {
          if (customMixLink.getAttribute('aria-disabled') === 'true' || customMixLink.href === '#') {
            e.preventDefault();
          }
        });

        customCheckboxes.forEach(cb => {
          cb.addEventListener('change', () => {
            const checked = customCheckboxes.filter(c => c.checked);
            if (checked.length > 2) {
              const toUncheck = checked.find(c => c !== cb);
              if (toUncheck) toUncheck.checked = false;
            }
            updateCustomMixLink();
          });
        });
        updateCustomMixLink();
      } catch (err) {
        console.error(err);
        titleEl.textContent = 'Fout bij laden van deel';
        metaEl.textContent = 'Controleer of je een webserver gebruikt (bijv. python -m http.server).';
      }
    });
  </script>
</body>
</html>

